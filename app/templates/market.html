{% extends "base.html" %}

{% block title %}Market Analysis{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Market Analysis <small>Price trends and valuation data for BMW 02 series in the UK</small></h1>
    <a href="{{ url_for('main.price_record_add') }}" class="btn btn-primary">+ Add Sale Record</a>
</div>

<form class="filters" method="get">
    <span class="filter-label">Filter</span>
    <select name="variant" onchange="this.form.submit()">
        <option value="">All Variants</option>
        {% for v in variants %}
        <option value="{{ v.id }}" {% if variant_filter == v.id %}selected{% endif %}>{{ v.name }}</option>
        {% endfor %}
    </select>
    {% if variant_filter %}
    <a href="{{ url_for('main.market') }}" class="btn btn-secondary btn-sm">Clear filter</a>
    {% endif %}
</form>

{% if chart_data %}
<div class="chart-container">
    <canvas id="priceChart"></canvas>
</div>
{% endif %}

{% if analysis %}
<h2 style="margin-bottom: 1.25rem;">Variant Analysis</h2>
<div class="analysis-grid">
    {% for a in analysis %}
    <div class="analysis-card">
        <h3>
            {{ a.variant.name }}
            <span class="badge badge-{{ a.trend }}">{{ a.trend }}</span>
        </h3>
        <dl class="analysis-stats">
            <dt>Sale records</dt>
            <dd>{{ a.count }}</dd>
            <dt>Price range</dt>
            <dd>&pound;{{ "{:,}".format(a.min_price) }} &ndash; &pound;{{ "{:,}".format(a.max_price) }}</dd>
            <dt>Overall avg</dt>
            <dd class="price">&pound;{{ "{:,}".format(a.avg_price) }}</dd>
            <dt>Recent avg (2025+)</dt>
            <dd class="price">&pound;{{ "{:,}".format(a.recent_avg) }}</dd>
        </dl>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state">
    <p>No price data yet.</p>
    <a href="{{ url_for('main.price_record_add') }}" class="btn btn-primary">Add the first sale record</a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if chart_data %}
<script>
const chartData = {{ chart_data | tojson }};
const colours = [
    '#c45a32', '#3672a4', '#3d8b5e', '#b88a2d',
    '#8b5e96', '#2e8b8b', '#c47832', '#5c5650', '#a94b28'
];

const datasets = Object.keys(chartData).map((variant, idx) => ({
    label: variant,
    data: chartData[variant].map(p => ({ x: p.date, y: p.price })),
    borderColor: colours[idx % colours.length],
    backgroundColor: colours[idx % colours.length] + '22',
    pointRadius: 5,
    pointHoverRadius: 7,
    pointBackgroundColor: colours[idx % colours.length],
    pointBorderColor: '#fff',
    pointBorderWidth: 2,
    tension: 0.2,
    fill: false,
    borderWidth: 2.5,
}));

new Chart(document.getElementById('priceChart'), {
    type: 'line',
    data: { datasets },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: 'Sale Prices Over Time (GBP)',
                font: { size: 15, family: "'Newsreader', Georgia, serif", weight: '500' },
                color: '#1a1612',
                padding: { bottom: 16 }
            },
            legend: {
                labels: {
                    font: { size: 12, family: "'Inter', sans-serif" },
                    color: '#5c5650',
                    usePointStyle: true,
                    pointStyle: 'circle',
                    padding: 16
                }
            },
            tooltip: {
                backgroundColor: '#2c2418',
                titleFont: { family: "'Inter', sans-serif", size: 12 },
                bodyFont: { family: "'Inter', sans-serif", size: 12 },
                cornerRadius: 8,
                padding: 10,
                callbacks: {
                    label: ctx => {
                        const point = chartData[ctx.dataset.label][ctx.dataIndex];
                        return `${ctx.dataset.label}: £${ctx.parsed.y.toLocaleString()} (${point.condition})`;
                    }
                }
            }
        },
        scales: {
            x: {
                type: 'time',
                time: { unit: 'month', tooltipFormat: 'DD MMM YYYY' },
                title: { display: true, text: 'Date Sold', color: '#9a918a', font: { size: 12 } },
                grid: { color: '#eee9e2' },
                ticks: { color: '#9a918a', font: { size: 11 } }
            },
            y: {
                title: { display: true, text: 'Price (£)', color: '#9a918a', font: { size: 12 } },
                grid: { color: '#eee9e2' },
                ticks: { callback: v => '£' + v.toLocaleString(), color: '#9a918a', font: { size: 11 } }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}
