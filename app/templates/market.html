{% extends "base.html" %}

{% block title %}Market Analysis{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Market Analysis <small>Price trends and valuation data for BMW 02 series in the UK</small></h1>
    <a href="{{ url_for('main.price_record_add') }}" class="btn btn-primary">+ Add Sale Record</a>
</div>

<form class="filters" method="get">
    <span class="filter-label">Filter</span>
    <select name="variant" onchange="this.form.submit()">
        <option value="">All Variants</option>
        {% for v in variants %}
        <option value="{{ v.id }}" {% if variant_filter == v.id %}selected{% endif %}>{{ v.name }}</option>
        {% endfor %}
    </select>
    {% if variant_filter %}
    <a href="{{ url_for('main.market') }}" class="btn btn-secondary btn-sm">Clear filter</a>
    {% endif %}
</form>

{% if chart_data %}
<div class="chart-container">
    <canvas id="priceChart"></canvas>
</div>
{% endif %}

{% if analysis %}
<h2 style="margin-bottom: 1.25rem;">Variant Analysis</h2>
<div class="analysis-grid">
    {% for a in analysis %}
    <div class="analysis-card">
        <h3>
            {{ a.variant.name }}
            <span class="badge badge-{{ a.trend }}">{{ a.trend }}</span>
        </h3>
        <dl class="analysis-stats">
            <dt>Sale records</dt>
            <dd>{{ a.count }}</dd>
            <dt>Price range</dt>
            <dd>&pound;{{ "{:,}".format(a.min_price) }} &ndash; &pound;{{ "{:,}".format(a.max_price) }}</dd>
            <dt>Overall avg</dt>
            <dd class="price">&pound;{{ "{:,}".format(a.avg_price) }}</dd>
            <dt>Recent avg (2025+)</dt>
            <dd class="price">&pound;{{ "{:,}".format(a.recent_avg) }}</dd>
        </dl>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state">
    <p>No price data yet.</p>
    <a href="{{ url_for('main.price_record_add') }}" class="btn btn-primary">Add the first sale record</a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if chart_data %}
<script>
const chartData = {{ chart_data | tojson }};
const colours = [
    '#003d7a', '#1a5a9e', '#2d6a3f', '#92700c',
    '#5c4a8a', '#2a7a7a', '#8b5a2b', '#525252', '#9b2c2c'
];

const datasets = Object.keys(chartData).map((variant, idx) => ({
    label: variant,
    data: chartData[variant].map(p => ({ x: p.date, y: p.price })),
    borderColor: colours[idx % colours.length],
    backgroundColor: colours[idx % colours.length] + '18',
    pointRadius: 4,
    pointHoverRadius: 6,
    pointBackgroundColor: colours[idx % colours.length],
    pointBorderColor: '#fff',
    pointBorderWidth: 1.5,
    tension: 0.15,
    fill: false,
    borderWidth: 2,
}));

new Chart(document.getElementById('priceChart'), {
    type: 'line',
    data: { datasets },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: 'SALE PRICES OVER TIME (GBP)',
                font: { size: 11, family: "'Helvetica Neue', Helvetica, Arial, sans-serif", weight: '500' },
                color: '#737373',
                padding: { bottom: 20 },
                letterSpacing: '0.1em'
            },
            legend: {
                labels: {
                    font: { size: 11, family: "'Helvetica Neue', Helvetica, Arial, sans-serif" },
                    color: '#525252',
                    usePointStyle: true,
                    pointStyle: 'rect',
                    padding: 20
                }
            },
            tooltip: {
                backgroundColor: '#003d7a',
                titleFont: { family: "'Helvetica Neue', Helvetica, Arial, sans-serif", size: 11 },
                bodyFont: { family: "'Helvetica Neue', Helvetica, Arial, sans-serif", size: 11 },
                cornerRadius: 0,
                padding: 10,
                callbacks: {
                    label: ctx => {
                        const point = chartData[ctx.dataset.label][ctx.dataIndex];
                        return `${ctx.dataset.label}: £${ctx.parsed.y.toLocaleString()} (${point.condition})`;
                    }
                }
            }
        },
        scales: {
            x: {
                type: 'time',
                time: { unit: 'month', tooltipFormat: 'DD MMM YYYY' },
                title: { display: true, text: 'DATE SOLD', color: '#a3a3a3', font: { size: 10, weight: '500' } },
                grid: { color: '#ebebeb' },
                ticks: { color: '#a3a3a3', font: { size: 10 } }
            },
            y: {
                title: { display: true, text: 'PRICE (£)', color: '#a3a3a3', font: { size: 10, weight: '500' } },
                grid: { color: '#ebebeb' },
                ticks: { callback: v => '£' + v.toLocaleString(), color: '#a3a3a3', font: { size: 10 } }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}
